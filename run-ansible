#!/bin/sh

if [ -n $LIMIT_TO_HOSTS ]; then
  echo "LIMIT_TO_HOSTS is: ${LIMIT_TO_HOSTS}"
fi

echo "Files in /root/.ssh"
ls /root/.ssh

HOSTS=`mktemp`
echo "[all_hosts]" > $HOSTS
for HOST in $LIMIT_TO_HOSTS
do
  echo $HOST >> $HOSTS

  echo "Doing ping to $HOST"
  ping -c 2 $HOST

  echo "Executing test command on host"
  ssh -i ~/.ssh/automation-key root@$HOST "echo $HOME"
done

echo "Installing to: $(cat $HOSTS)"

# TODO: Need to determine the hosts and save them to ansible/hosts or to a temp file
ansible-playbook -i $HOSTS ansible/playbook.yml
