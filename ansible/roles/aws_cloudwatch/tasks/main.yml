- name: Download awslogs-agent-setup
  get_url:
    url: https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py
    dest: /tmp/awslogs-agent-setup.py
    mode: u+rwx
  tags: aws_cloudwatch

- name: Copy config file
  copy:
    src: roles/aws_cloudwatch/files/cloudwatch-config.cfg
    dest: /etc/cloudwatch-config.cfg
  tags: aws_cloudwatch

- name: Parse the config file
  lineinfile:
    dest: /etc/cloudwatch-config.cfg
    line: log_group_name = '{{ cluster_name }}'-hosts
    state: present

  shell: sed -i "s|@@LOG_GROUP_NAME@@|'{{ cluster_name }}'" /etc/cloudwatch-config.cfg
  tags: aws_cloudwatch

- name: Execute the awslogs-agent-setup
  shell: /tmp/awslogs-agent-setup.py -n -r {{ region }} -c /etc/cloudwatch-config.cfg
  tags: aws_cloudwatch

- name: Start service
  service: name=awslogs state=started
  tags: aws_cloudwatch
